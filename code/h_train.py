import os
import torch
from datetime import datetime
from ultralytics import YOLO

# =========================================================
# âœ… [ì‚¬ìš©ì ê¸°ë³¸ ì„¤ì •]
# =========================================================
USER_NAME = "kwkoo"
MODEL_NUM = 5
BATCH_SIZE = 48
PROJECT_PATH = "../model"       
DATA_CONFIG = "../data/data.yaml"

# ğŸ’¡ [ì•ˆì „ ì¥ì¹˜] ì‹¤ì œ ì‚¬ìš© ê°€ëŠ¥í•œ GPU ê°œìˆ˜ í™•ì¸ (ì„¤ì •ë³´ë‹¤ ì ìœ¼ë©´ ìë™ ì¡°ì •)
available_gpus = list(range(torch.cuda.device_count()))
if len(available_gpus) < 4:
    print(f"âš ï¸ [ì£¼ì˜] ì„¤ì •ëœ GPUëŠ” 4ê°œì§€ë§Œ, ì‹¤ì œ ê°ì§€ëœ GPUëŠ” {len(available_gpus)}ê°œì…ë‹ˆë‹¤.")
    GPUS = available_gpus  # ìˆëŠ” ë§Œí¼ë§Œ ì‚¬ìš©
else:
    GPUS = [0, 1, 2, 3]    # 4ê°œ ë‹¤ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©

# =========================================================
# ğŸ›ï¸ [í•˜ì´í¼íŒŒë¼ë¯¸í„° ìƒì„¸ ì„¤ì •]
# =========================================================
HYPER_PARAMS = {
    # 1. í•™ìŠµ ê¸°ê°„ ì—°ì¥: ì‘ì€ ê°ì²´ëŠ” í•™ìŠµ ë‚œì´ë„ê°€ ë†’ì•„ ì—í¬í¬ê°€ ë” í•„ìš”í•¨
    'epochs': 150,          # ê¸°ì¡´ 50 -> 150 ê¶Œì¥ (ì¶©ë¶„íˆ í•™ìŠµí•  ì‹œê°„ í™•ë³´)
    'patience': 50,         # ê¸°ì¡´ 10 -> 50 (ì¡°ê¸° ì¢…ë£Œ ë°©ì§€)
    
    # 2. í•´ìƒë„ ì¦ê°€ (â˜…ê°€ì¥ ì¤‘ìš”): 512ëŠ” í”½ì…€ì´ ë­‰ê°œì ¸ì„œ ì‘ì€ ê°ì²´ê°€ ì‚¬ë¼ì§
    'imgsz': 1024,           # ìµœì†Œ 640, VRAM ì—¬ìœ  ìˆë‹¤ë©´ 1024 ê¶Œì¥
    'batch': 16,            # imgszë¥¼ í‚¤ì› ìœ¼ë¯€ë¡œ VRAM OOM ë°©ì§€ë¥¼ ìœ„í•´ ë°°ì¹˜ ì‚¬ì´ì¦ˆ ì¶•ì†Œ (48 -> 16 or 24)
    
    'device': GPUS,
    'workers': 8,
    
    'optimizer': 'auto',
    'cos_lr': True,
    'lr0': 0.01,
    'lrf': 0.01,
    'momentum': 0.937,
    'weight_decay': 0.0005,
    'warmup_epochs': 3.0,
    
    'box': 7.5,
    'cls': 0.5,
    'dfl': 1.5,
    
    # 3. ë°ì´í„° ì¦ê°•(Augmentation) ì¡°ì ˆ
    # ì‘ì€ ê°ì²´ì— ë¶ˆë¦¬í•œ ì¦ê°•(ì¶•ì†Œ, ë¹„í‹€ê¸°)ì„ ì¤„ì—¬ì•¼ í•¨
    'hsv_h': 0.015,
    'hsv_s': 0.7,
    'hsv_v': 0.4,
    'degrees': 0.0,         # íšŒì „ ì‹œ ê°ì²´ ì •ë³´ ì†ì‹¤ ê°€ëŠ¥ì„± ìˆìŒ -> 0.0 ê¶Œì¥
    'translate': 0.1,
    'scale': 0.2,           # ê¸°ì¡´ 0.5 -> 0.2 (ì´ë¯¸ì§€ë¥¼ ë„ˆë¬´ ì‘ê²Œ ì¤„ì´ì§€ ì•Šë„ë¡ ì œí•œ)
    'shear': 0.0,
    'perspective': 0.0,
    'flipud': 0.0,
    'fliplr': 0.5,
    
    # 4. Mosaic & Mixup ì¡°ì ˆ
    # Mosaicì€ ì´ë¯¸ì§€ë¥¼ 4ë“±ë¶„ í•©ì¹˜ë©´ì„œ ê°ì²´ë¥¼ 1/4ë¡œ ì¶•ì†Œì‹œí‚´ -> ì‘ì€ ê°ì²´ì— ì¹˜ëª…ì ì¼ ìˆ˜ ìˆìŒ
    'mosaic': 0.5,          # ê¸°ì¡´ 1.0 -> 0.0 ~ 0.5 (í™•ë¥ ì„ ë‚®ì¶”ê±°ë‚˜ ì•„ì˜ˆ ë”)
    'mixup': 0.1,           # ìœ ì§€ (ê²¹ì¹˜ëŠ” ê²ƒì€ í•™ìŠµì— ë„ì›€ ë  ìˆ˜ ìˆìŒ)
    
    # 5. Copy-Paste (ì¶”ì²œ)
    # ê°ì²´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ì–´ í•™ìŠµ ë¹ˆë„ë¥¼ ë†’ì„
    'copy_paste': 0.3,      # ê¸°ì¡´ 0.0 -> 0.3 (ì‘ì€ ê°ì²´ í•™ìŠµ ê¸°íšŒ ì¦ê°€)
}

MODEL_DICT = {
    1: 'yolo11n.pt', 2: 'yolo11s.pt', 3: 'yolo11m.pt', 4: 'yolo11l.pt', 5: 'yolo11x.pt'
}

def main():
    # -----------------------------------------------------
    # 2. í´ë” ì´ë¦„ ë° ëª¨ë¸ ì„¤ì •
    # -----------------------------------------------------
    current_time = datetime.now().strftime("%Y%m%d_%H%M%S")
    model_name = MODEL_DICT.get(MODEL_NUM, MODEL_DICT[1])
    pure_model_name = model_name.replace('.pt', '')
    
    folder_name = f"{USER_NAME}_{pure_model_name}_{current_time}"

    print(f"\n" + "="*40)
    print(f"â–¶ [INFO] ì‚¬ìš©ì: {USER_NAME}")
    print(f"â–¶ [INFO] ëª¨ë¸: {model_name}")
    print(f"â–¶ [INFO] ì‚¬ìš©í•  GPU: {GPUS}")
    print(f"â–¶ [INFO] ì €ì¥ í´ë”: {folder_name}")
    print("="*40 + "\n")

    # -----------------------------------------------------
    # 3. ê²½ë¡œ ì ˆëŒ€ ê²½ë¡œ ë³€í™˜
    # -----------------------------------------------------
    abs_data_config = os.path.abspath(DATA_CONFIG)
    abs_project_path = os.path.abspath(PROJECT_PATH)

    # -----------------------------------------------------
    # 4. í•™ìŠµ ì‹œì‘ (ì—¬ê¸°ê°€ ë¹ ì ¸ ìˆì—ˆìŒ!)
    # -----------------------------------------------------
    model = YOLO(model_name)

    results = model.train(
        data=abs_data_config,
        project=abs_project_path,
        name=folder_name,
        exist_ok=True,
        pretrained=True,
        verbose=True,
        **HYPER_PARAMS  # ë”•ì…”ë„ˆë¦¬ ì„¤ì • ì£¼ì…
    )

# =========================================================
# â˜… [ì¤‘ìš”] ì‹¤í–‰ ì§„ì…ì  (ì´ê²Œ ì—†ìœ¼ë©´ ì‹¤í–‰ ì•ˆ ë¨)
# =========================================================
if __name__ == '__main__':
    # ìœˆë„ìš°/ë©€í‹°í”„ë¡œì„¸ì‹± ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ê¼­ í•„ìš”í•©ë‹ˆë‹¤.
    main()


    